# See the README file for why we are building tensorflow

# Note that these versions need to match, you can't in general build using
# a different version of bazel
TENSORFLOW_VERSION = 1.14.0
BAZEL_VERSION = 0.24.1

EXTRA_DIST+= thirdparty/README
# Don't put the wheel in the dist file. It is really pretty big. We can
# reevaluate that if needed, but for now skip
# EXTRA_DIST+= thirdparty/tensorflow-1.14.0-cp37-cp37m-linux_x86_64.whl

tensorflow-$(TENSORFLOW_VERSION).tar.gz:
	curl -L -o $@ https://github.com/tensorflow/tensorflow/archive/v$(TENSORFLOW_VERSION).tar.gz

bazel:
	curl -L -o $@ https://github.com/bazelbuild/bazel/releases/download/$(BAZEL_VERSION)/bazel-$(BAZEL_VERSION)-linux-x86_64
	chmod +x $@

tensorflow-wheel: tensorflow-$(TENSORFLOW_VERSION).tar.gz bazel
	-rm -r tensorflow-$(TENSORFLOW_VERSION)
	tar -xf $<
	PATH=$(abs_builddir):$${PATH} which bazel && \
          cd tensorflow-$(TENSORFLOW_VERSION) && \
          ( yes "" | ./configure ) && \
          bazel build -c opt \
             //tensorflow/tools/pip_package:build_pip_package && \
          ./bazel-bin/tensorflow/tools/pip_package/build_pip_package $(abs_srcdir)/thirdparty

