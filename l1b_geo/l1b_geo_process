#! /usr/bin/env python
#
# This runs the L1B Geo process.
import warnings

# Have a warning message that we can't do anything about - suppress it
with warnings.catch_warnings():
    warnings.filterwarnings("ignore", category=UserWarning)
    import geocal
import ecostress
from loguru import logger
from pathlib import Path
import sys

version = "1.0"
usage = """Usage:
  l1b_geo_process [options] <run_config>
  l1b_geo_process [options] <l1a_raw_att> <osp_dir> <prod_dir> <l1b_rad>...
  l1b_geo_process -h | --help
  l1b_geo_process -v | --version

This runs the L1B Geo process.

Options:
  -h --help         
       Print this message

  --ecostress-band=d
       Ecostress band to use. Band 1 is 8.28 micron, Band 2 is 8.63
       and so on. By convention Band 0 is the SWIR band. -1 means 
       use the value found in the configuration file
       [default: -1]

  --force-night
       Testing option to force the data to be treated as night, overriding
       what the l1b_rad data says.

  --landsat-band=d
       Landsat band to match to. For band 6, we have both low and high gain.
       Enter this as 61 and 62. -1 means use the value found in the
       configuration file [default: -1]

  --number-cpu=d
       Number of CPUs to use when processing. Ignored if we are using a 
       run_config file, this is instead passed through the config file.
       [default: 10]

  --number-line=d
       Number of lines to process. Normally you process the whole scene, but
       can be useful for testing to process only a subset. [default: -1]

  --orbit-offset=d
       For testing, fake errors in the orbit. This is an alternative from
       running the full end-to-end test generation, where we take the orbit
       from l1a_raw but then add errors. The errors should be the yaw,pitch,
       roll errors to add in degrees.

  --verbose
       Print more information as we run to stderr.

  -v --version      
       Print program version
"""

args = geocal.docopt_simple(usage, version=version)

# Can use this to wait a short time so we can attach strace to this
# process, useful to find all the files that we are accessing.
if False:
    print("Waiting a short time")
    import time

    time.sleep(20)

logger.remove()
if args.verbose:
    logger.add(sys.stderr, level="DEBUG")
else:
    logger.add(sys.stderr, level="INFO")

try:
    with logger.catch(reraise=True):
        l1bgeo = ecostress.L1bGeoProcess(
            run_config=Path(args.run_config) if args.run_config is not None else None,
            prod_dir=Path(args.prod_dir) if args.prod_dir is not None else None,
            l1a_raw_att=Path(args.l1a_raw_att) if args.l1a_raw_att is not None else None,
            l1_osp_dir=Path(args.osp_dir) if args.osp_dir is not None else None,
            l1b_rad=[Path(i) for i in args.l1b_rad]
            if args.l1b_rad is not None
            else None,
            ecostress_band=args.ecostress_band,
            landsat_band=args.landsat_band,
            number_cpu=args.number_cpu,
            number_line=args.number_line,
            orbit_offset=[float(i) for i in args.orbit_offset.split(",")]
            if args.orbit_offset is not None
            else None,
            force_night=args.force_night,
        )
        l1bgeo.run()
        logger.info("L1B_GEO_PGE:INFO-0-[Job Successful]")
except Exception:
    logger.info("L1B_GEO_PGE:ERROR-2-[Unexpected Error]")
    raise
except:
    logger.info("L1B_GEO_PGE:ERROR-2-[Unexpected Error]")
    raise
